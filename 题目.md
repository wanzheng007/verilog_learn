## 101，组合逻辑和时序逻辑设计

### 例

- 异或逻辑的组合逻辑实现
- 异或逻辑的时序逻辑实现
- $z=a\wedge b$

## 102，分频计数器设计

### 例

- 输入时钟100MHz，产生一个1MHz的低频时钟
  - 100MHz / 1MHz = 100
  - 即需要对100MHz时钟做100分频
  - 计数器循环计数周期是0~99

### 练习

- 对一个25MHz的时钟，分频产生一个400kHz的时钟
- 编写Verilog代码；编写测试脚本，搭建仿真平台；运行仿真，查看波形

## 103，使能时钟设计

### 例

- 输入时钟100MHz，产生一个5MHz的时钟使能信号，并使此时钟使能信号进行0~15的周期计数
  - 100MHz / 5MHz = 20
  - 即需要对100MHz时钟做20分频的计数（0~19周期计数）
  - 每20个100MHz的时钟周期，都有一个保持1个时钟周期的高脉冲信号产生

### 练习

对一个25MHz的时钟，分频产生一个5MHz的时钟使能信号

- 编写Verilog代码；编写测试脚本，搭建仿真平台；运行仿真，查看波形

## 104，基于BUFGCE原语的门控时钟设计

### 例

- FPGA系统时钟100MHz
- 系统每秒进行一次数据的采集与处理，每次维持10ms，其余时间空闲
- 希望系统空闲时，关闭100MHz的工作时钟
- 使用BUFGCE原语实现此功能

### 练习

1. FPGA系统时钟100MHz

- 系统每隔10ms进行一次数据的采集与处理，每次维持2ms，其余时间空闲
- 希望系统空闲时，关闭100MHz的工作时钟
- 使用BUFGCE原语实现此功能
  - 编写Verilog代码；编写测试脚本，搭建仿真平台；运行仿真，查看波形

2. FPGA系统快速时钟100MHz，慢速时钟1MHz

- 系统每秒进行一次数据的采集与处理，每次维持10ms，其余时间空闲
- 数据采集与处理时，FPGA工作在100MHz快时钟（10ms/s）
- 系统空闲时，FPGA工作在1MHz慢时钟（990ms/s）
- 使用Xilinx BUFGMUX原语实现此功能
  - 编写Verilog代码；编写测试脚本，搭建仿真平台；运行仿真，查看波形
  - 参考文档：Xilinx《ug472_7Series_Clocking.pdf》

## 105，Verilog中的并行设计

### 例

1. 使用两个always语句分别实现4位加法器，看看是否计数值的变化是同步的
2. 分别将同一个递增变化的输入值赋给同一个always语句中的两个寄存器，看看这两个寄存器的值是否同步递增

### 练习

类似实例2的设计，将一个递增变化的输入值赋值给寄存器1，同时寄存器1赋值给寄存器2，寄存器1和寄存器2在同一个always语句里面实现，看看这两个寄存器的值是如何变化的，思考一下这样变化的结果符合FPGA的并行性吗？

（这样设计的结果依旧符合FPGA的并行性，只要是使用非阻塞赋值 `<=`，就是符合并行性的）

## 106，同步复位与异步复位

### 例

1. 设计同步复位与异步复位信号，通过波形仿真，看看两者的区别
2. 对异步复位信号，先做同步处理，再作异步复位信号使用

### 练习

删除设计模块中一些不必要的数据逻辑的复位控制

- 液晶屏驱动工程at7_ex14（STAR FPGA开发板），液晶屏显示器驱动模块lcd_ctrl.v
- 对此模块的复位做优化，看看哪些逻辑中的复位信号其实是可以不需要的
- 修改后可以比对lcd_ctrl_reset_optimize.v模块，看看修改的结果是否一致

## 107，脉冲边沿检测设计

### 例

对变化信号做脉冲边沿检测，检测上升沿，生成一个脉冲信号

### 练习

1. 使用脉冲边沿检测法设计一个下降沿检测功能

   （将i_pulse[0]取反，与i_pulse[1]相与，就可以检测下降沿）
2. 使用脉冲边沿检测法设计一个双沿检测功能

   （将i_pulse[0]与i_pulse[1]直接异或，就可以做到双沿检测）

## 108，脉冲计数器

### 例

- 输入脉冲：1路
- 使能信号：高电平进行计数，低电平清零计数器
- 计数器：在使能信号高电平期间，对脉冲信号的上升沿进行检测并递增计数值

### 练习

设计一个脉冲计数器，其功能如下

- 输入脉冲：4路脉冲信号，分别对每路进行脉冲检测并计数
- 使能信号：高电平进行计数，低电平清零计数器
- 计数器：在使能信号高电平期间，对脉冲信号的上升沿进行检测并递增计数值
- 编写测试脚本，进行仿真验证

## 109，模块化设计

### 例

设计一个脉冲计数器，其功能如下

- 输入脉冲：**4路脉冲信号**，分别对每路进行脉冲检测并计数
- 使能信号：高电平进行计数，低电平清零计数器
- 计数器：在使能信号高电平期间，对脉冲信号的上升沿进行检测并递增计数值
- 编写测试脚本，进行仿真验证

### 练习

设计一个脉冲计数器，其功能如下

- 输入脉冲：16路脉冲信号，分别对每路进行脉冲检测并计数
- 使能信号：高电平进行计数，低电平清零计数器
- 计数器：在使能信号高电平期间，对脉冲信号的上升沿进行检测并递增计数值
- 编写测试脚本，进行仿真验证

## 110，generate语法的使用

### 例

设计一个脉冲计数器，其功能如下

- 输入脉冲：**16路脉冲信号**，分别对每路进行脉冲检测并计数
- 使能信号：高电平进行计数，低电平清零计数器
- 计数器：在使能信号高电平期间，对脉冲信号的上升沿进行检测并递增计数值
- 编写测试脚本，进行仿真验证

### 练习

使用generate语法设计一个脉冲计数器，其功能如下

- 输入脉冲：16路脉冲信号，分别对每路进行脉冲检测并计数
- 使能信号：**16路脉冲分别有独立的使能信号**，高电平进行计数，低电平清零计数器
- 计数器：在使能信号高电平期间，对脉冲信号的上升沿进行检测并递增计数值
- 编写测试脚本，进行仿真验证

## 111，频率计数器

### 例

在使能信号的控制下，计算输入脉冲的每两个上升沿之间的时钟周期数并输出，即输出脉冲频率的计数值

- 输入信号
  - 周期性脉冲信号：需要做检测的脉冲频率信号
  - 使能信号：高电平进行频率计数，低电平清零计数器
- 输出信号
  - 计数值：输出脉冲频率的计数值
  - 有效信号：该信号拉高时，输出计数值有效

### 练习

1. 设计 一个高脉冲频率计数器(只对信号的高电平进行时钟周期计数)，功能如下

- 输入使能信号，该信号高电平进行计数，低电平不做计数并清零计数器
- 在使能信号高电平期间，对脉冲信号的高电平所维持的时钟周期数进行计数并输出
- 输出有效信号拉高时，对应的脉冲计数值有效
- 编写测试脚本，进行仿真验证

2. 对题1的高脉冲频率计数器，用模块化设计方法设计4路
3. 对题1的高脉冲频率计数器，用generate for语法设计16路

## 112，条件判断if与分支判断case语句的使用

### 例

使用if与case语句进行4位格雷码转换的设计

### 练习

1. 以时序逻辑的形式，使用if语句设计8-3编码器
2. 以时序逻辑的形式，使用case语句设计8-3编码器

## 113，4位格雷码计数器

### 例

- 4位格雷码计数器设计
- 系统任务\$display、\$monitor语法学习
- 在仿真测试脚本中使用\$monitor监控计数值
- Vivado创建工程进行板级调试

### 练习

- 设计实现一个8位格雷码计数器
- 在仿真测试脚本中使用系统任务\$monitor、\$monitoron、\$monitoroff
- 只对计数器取值为100-200区间进行输出打印

## 114，基于查找表的8位格雷码转换

### 例

- 查找表（look-up-table）
- 创建Vivado工程，添加并配置ROM IP
- ROM初始化COE文件制作
- Verilog编码，仿真验证

### 练习

- 用查找表设计实现一个正弦波形发生器
- 寻址的位宽是10位，数据量是1024个，输出的数据是16位

## 115，基于查找表的正弦波发生器

### 例

- 基于查找表（Look-up-table）
- 创建Vivado工程，添加并配置ROM IP
- 使用Matlab生成ROM初始化COE文件
- Verilog编码，仿真验证

### 练习

- 了解一下电机加减速的应用是如何用Verilog设计实现的

## 116，常量的参数化及跨模块传递

### 例

- localparam和parameter的基本语法与使用说明
- 格雷码转换的快速算法
- 位宽参数化的快速格雷码转换设计

### 练习

- 将例110中的o_pulse_cnt的数据位宽修改为可以在模块间传递的parameter，并且分别用8bit和16bit两种位宽方式进行一下仿真测试

## 117，Testbench中的文本文件写入操作

### 例

- 系统任务\$fopen，\$fclose、和\$fwrite使用说明
- 格雷码转换设计的仿真测试结果写入txt文本

### 练习

- 将例115中的testbench进行修改，将一组完整周期的正弦波数据存储到文本文件sin_rom.txt中
- sin_rom.txt的内容格式与sin_rom.coe一样，可直接比较两个文件的结果是否完全一样
  - 打印字符串、标点符号和10进制数据等

## 118，Testbench中的文本文件读取操作

### 例

- 系统任务\$readmemh与\$readmemb的使用说明
- txt文本文件中8位格雷码数据的读取与使用

### 练习

- 将例115中的testbench进行修改
- 对sin_rom.coe文件进行修改，使得一组完整周期的正弦波数据存储在sin_rom.txt中，使用\$readmemh进行读取
- 同时打印设计文件输出的正弦波形数据与sin_rom.txt中的数据，比对他们是否一致

## 119，基于随机数的自动化仿真测试平台

### 例

- 系统任务\$random的使用说明
- 使用\$random、文件读取、\$display构建自动化测试平台

### 练习

- 将例115中的testbench进行修改
- 对sin_rom.coe文件进行修改，使得一组完整周期的正弦波数据存储在sin_rom.txt中，使用\$readmemh进行读取
- 使用\$random产生随机数，作为测试激励，比对设计产生的结果与sin_rom.txt的结果是否一致，打印对比信息

## 120，行为级Verilog语法小结

### 例

- 行为级、RTL级、门级语法简介
- 常用的行为级Verilog语法介绍

### 练习

- 在testbench中使用多个initial和always语句，比较并体验他们在执行时的并行性
- 在testbench中使用不同的时间刻度`timescale，利用时间戳\$time和\$realtime打印时间信息
- 在testbench中使用时间延时#，事件触发@，事件等待wait等语法
- 在testbench中使用阻塞赋值（=）和非阻塞赋值（<=）语句分别进行多个变量的运算，比对并体验“顺序”和“并行”执行的结果差异
- 在testbench中分别使用顺序块begin end和并行块fork join进行多条语句赋值，比对并体验“顺序”和“并行”执行的结果差异

## 121，可配置的PWM设计

### 例

- 可配置的PWM设计

  - 功能和接口定义
  - 设计思路梳理
  - 设计代码实现
- 基于任务（task）的PWM设计仿真验证
- 基于Vivado VIO的PWM设计板级调试

## 122，基于任务（task）的PWM设计仿真验证

### 例

- 编写测试脚本，利用task输出PWM波形

### 练习

- 使用显示命令\$display、\$monitor、\$times显示PWM的周期，高电平显示的时间，频率等

## 123，基于Vivado VIO的PWM设计板级调试

### 例

- VIO，即虚拟IO调试接口
- VIO可用于实时的监控或驱动FPGA内部信号状态

### 练习

- 将本实例的设计代码，修改为蜂鸣器发声周期和发声时间（高电平时间）以ms为单位
- 参考《103使能时钟设计》一节中提到的使能时钟的方式进行设计

## 124，超声波测距设计

### 例

- 超声波测距原理
- 需求分析与功能定义
  - 每隔**100ms时间**，定时产生**10us时间**的TRI高脉冲给到超声波测距模块，用于触发超声波测距模块工作
    - 每隔**100ms时间**：查看spec，通过查看测距的范围，推断工作时间间隔，反正前后两次检测出现重叠现象
    - TRI高脉冲**10us时间**：查看spec确认
  - 采集回响信号ECHO的高脉冲保持时间
  - 将ECHO高脉冲保持时间换算为距离信息：$s=0.173*t$
  - 人机交互方式：VIO
- 模块划分与接口定义
- 代码设计、仿真验证、板级调试

### 练习

- 消化理解本实例的所有设计代码，按照**需求分析、功能定义、模块划分和接口定义**的方式，自己理一下思路，同时写代码实现一遍所有模块的功能
- 在当前设计的基础上，增加一个均值滤波模块，对每连续的16个采样数据做均值滤波

## 129，自动售贩机状态机设计

### 例

- 自动售贩机的需求

  - 使用1元、2元、5元面值的纸币进行支付，获取6元的物品，不设找零
    - 输入：1元，2元，5元
    - 判定条件：>=6元
    - 输出：可以交货（输入额满足判断条件）
- 接口定义
- 状态机草图绘制

  ```mermaid
  graph LR
  A((IDLE));
  B[IN.1];C[IN.2];D[IN.3];E[IN.4];F[IN.5];G[IN.6];
  H((DONE));
  
  A-->B-->|<=6|C-->|<=6|D-->|<=6|E-->|<=6|F-->|<=6|G;
  C-->|>=6|H;
  D-->|>=6|H;
  E-->|>=6|H;
  F-->|>=6|H;
  G-->|>=6|H;
  H-->|o_done|A;
  ```

### 练习

- 在本课时的实例基础上，增加找零功能
  - 分析需求，定义接口，绘制草图
  - 使用状态机实现设计
